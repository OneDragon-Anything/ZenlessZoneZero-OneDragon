# OneDragon 框架设计开发文档

## 1. 概述

OneDragon 是一个专为游戏自动化设计的 Python 框架，提供了完整的游戏自动化解决方案。框架采用模块化设计，支持多种游戏的自动化需求，具有高度的可扩展性和可配置性。

### 1.1 设计目标

- **通用性**：提供通用的游戏自动化基础设施
- **可扩展性**：支持不同游戏的特定需求扩展
- **稳定性**：提供可靠的错误处理和重试机制
- **易用性**：简化游戏自动化脚本的开发流程

### 1.2 核心特性

- 基于状态机的操作流程控制
- 多种图像识别技术（OCR、模板匹配、YOLO）
- 条件操作系统支持复杂的游戏逻辑
- 多线程异步处理提升性能
- 完善的配置管理系统
- 多种通知方式支持

## 2. 整体架构

### 2.1 架构层次

`

              应用层 (Application)        
       
    ZZZ 游戏        其他游戏         
    自动化应用       自动化应用        
       

              框架层 (Framework)          
   
           OneDragon 核心框架           
        
    Operation Matcher   Config   
        
        
    Controller Screen    Utils    
        
   

              基础层 (Infrastructure)     
   
    Python 运行时 + 第三方库依赖        
    (OpenCV, ONNX, PySide6, etc.)      
   

`

### 2.2 核心模块关系

`mermaid
graph TB
    A[OneDragonContext] --> B[Operation]
    A --> C[Controller]
    A --> D[Matcher]
    A --> E[ScreenLoader]
    
    B --> F[OperationNode]
    B --> G[ConditionalOperator]
    
    D --> H[OcrMatcher]
    D --> I[TemplateMatcher]
    
    C --> J[ControllerBase]
    
    E --> K[ScreenArea]
    E --> L[TemplateLoader]
    
    G --> M[AtomicOp]
    G --> N[StateRecorder]
`

## 3. 核心组件设计

### 3.1 上下文管理 (OneDragonContext)

**设计理念**：统一的上下文管理，提供全局状态和资源访问。

**核心功能**：
- 全局配置管理
- 组件生命周期管理
- 事件总线机制
- 资源初始化和清理

**关键特性**：
- 单例模式确保全局唯一性
- 懒加载机制优化启动性能
- 异步初始化支持

### 3.2 操作系统 (Operation)

**设计理念**：基于状态机的操作流程控制，支持复杂的游戏逻辑。

**核心组件**：
- **OperationBase**：所有操作的基类
- **Operation**：具体操作实现，支持节点图执行
- **OperationNode**：操作节点，表示单个执行步骤
- **OperationEdge**：节点间的连接关系

**执行流程**：
1. 构建操作节点图
2. 按照边的关系执行节点
3. 根据执行结果选择下一个节点
4. 支持重试和错误处理

### 3.3 条件操作系统 (ConditionalOperator)

**设计理念**：基于状态和条件的动态操作执行，适用于复杂的游戏场景。

**核心概念**：
- **StateRecorder**：状态记录器，跟踪游戏状态变化
- **SceneHandler**：场景处理器，根据状态触发相应操作
- **AtomicOp**：原子操作，最小的执行单元
- **OperationTask**：操作任务，包含多个原子操作的组合

**工作机制**：
1. 持续监控游戏状态
2. 状态变化时触发对应场景处理器
3. 执行相应的原子操作序列
4. 支持操作优先级和互斥控制

### 3.4 图像识别系统 (Matcher)

**设计理念**：多种识别技术结合，提供准确的游戏画面分析。

**识别技术**：
- **OCR识别**：基于ONNX的文字识别
- **模板匹配**：基于OpenCV的图像模板匹配
- **特征匹配**：基于SIFT/ORB的特征点匹配
- **YOLO检测**：基于深度学习的目标检测

### 3.5 控制器系统 (Controller)

**设计理念**：抽象的输入控制接口，支持多种输入方式。

**核心功能**：
- 鼠标点击和拖拽
- 键盘输入和按键
- 游戏窗口管理
- 截图功能

**扩展性**：
- 支持PC端控制
- 预留移动端控制接口
- 支持手柄输入

## 4. 设计模式应用

### 4.1 策略模式 (Strategy Pattern)

**应用场景**：不同的识别算法选择

### 4.2 观察者模式 (Observer Pattern)

**应用场景**：事件总线系统

### 4.3 模板方法模式 (Template Method Pattern)

**应用场景**：应用执行流程

### 4.4 工厂模式 (Factory Pattern)

**应用场景**：原子操作创建

## 5. 线程模型

### 5.1 线程池设计

框架采用多个专用线程池来处理不同类型的任务：

- **ONE_DRAGON_CONTEXT_EXECUTOR**：上下文相关操作
- **_od_conditional_op_executor**：条件操作执行
- **_battle_state_check_executor**：战斗状态检查
- **_auto_battle_operator_executor**：自动战斗操作

### 5.2 线程安全

- 使用 AtomicBool 和 AtomicInt 保证原子操作
- 关键资源使用锁保护
- 异步操作使用 Future 管理

## 6. 配置管理

### 6.1 配置层次结构

`
配置系统
 环境配置 (EnvConfig)
 项目配置 (ProjectConfig)  
 游戏配置 (GameConfig)
 自定义配置 (CustomConfig)
 应用配置 (AppConfig)
`

### 6.2 配置特性

- **YAML格式**：易于编辑和版本控制
- **实例隔离**：支持多实例独立配置
- **热更新**：运行时配置修改
- **类型安全**：配置项类型检查

## 7. 错误处理和日志

### 7.1 错误处理策略

- **分层错误处理**：不同层次的错误采用不同处理策略
- **重试机制**：可配置的重试次数和间隔
- **优雅降级**：关键错误时的安全退出

### 7.2 日志系统

- **多级日志**：DEBUG、INFO、WARN、ERROR
- **结构化日志**：便于分析和监控
- **日志轮转**：防止日志文件过大

## 8. 扩展机制

### 8.1 游戏适配扩展

1. 继承 OneDragonContext 创建游戏特定上下文
2. 继承 Application 创建游戏应用
3. 继承 Operation 创建游戏操作
4. 实现游戏特定的控制器

### 8.2 识别算法扩展

1. 实现 OcrMatcher 接口
2. 继承 YoloDetector 类
3. 添加新的模板匹配算法

### 8.3 通知方式扩展

1. 继承 NotificationBase 类
2. 实现具体的通知逻辑
3. 注册到通知管理器

## 9. 性能优化

### 9.1 图像处理优化

- **缓存机制**：模板和截图缓存
- **ROI优化**：只处理感兴趣区域
- **并行处理**：多线程图像识别

### 9.2 内存管理

- **对象池**：重用频繁创建的对象
- **弱引用**：避免循环引用
- **及时清理**：主动释放大对象

### 9.3 I/O优化

- **异步I/O**：非阻塞文件操作
- **批量操作**：减少系统调用
- **压缩存储**：减少存储空间

## 10. 开发规范

### 10.1 代码规范

- 遵循 PEP 8 代码风格
- 使用类型注解提高代码可读性
- 编写完整的文档字符串

### 10.2 测试规范

- 单元测试覆盖核心功能
- 集成测试验证组件协作
- 性能测试确保系统稳定

### 10.3 版本管理

- 语义化版本号
- 详细的变更日志
- 向后兼容性保证

---

本文档为 OneDragon 框架的设计开发文档，详细介绍了框架的架构设计、核心组件、设计模式等内容，为框架的进一步开发和扩展提供指导。
